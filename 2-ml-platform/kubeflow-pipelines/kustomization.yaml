apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Layer 1: Cluster-Scoped Resources (CRDs, Roles)
  - github.com/kubeflow/pipelines/manifests/kustomize/cluster-scoped-resources?ref=2.14.3
  # Layer 2: Core KFP Stack (env/dev includes MinIO)
  - github.com/kubeflow/pipelines/manifests/kustomize/env/dev?ref=2.14.3
  # Layer 3: Local Access
  - ingress.yaml

images:
  # Replaces the old AMD64-only image with a modern multi-arch release (I need this because I'm on Apple Silicon)
  - name: gcr.io/ml-pipeline/minio
    newName: minio/minio
    newTag: RELEASE.2024-01-11T07-46-16Z

# ----------------------------------------------------------------------
# FIX: Inject Missing MinIO Config for ml-pipeline
# ----------------------------------------------------------------------
patches:
  - target:
      kind: Deployment
      name: ml-pipeline
      namespace: kubeflow
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OBJECTSTORECONFIG_HOST
          value: minio-service.kubeflow
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OBJECTSTORECONFIG_PORT
          value: "9000"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OBJECTSTORECONFIG_BUCKETNAME
          value: mlpipeline
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OBJECTSTORECONFIG_ACCESSKEY
          value: minio
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OBJECTSTORECONFIG_SECRETACCESSKEY
          value: minio123
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OBJECTSTORECONFIG_SECURE
          value: "false"

namespace: kubeflow
